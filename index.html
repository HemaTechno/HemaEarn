<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>صفحتي</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    body {
      background: #111;
      color: white;
      font-family: Arial;
      text-align: center;
      padding: 20px;
    }
    .card {
      background: #1e1e1e;
      border: 2px solid red;
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      width: 90%;
      max-width: 500px;
    }
    button {
      padding: 10px 20px;
      background-color: red;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
    }
    input {
      padding: 10px;
      margin-top: 10px;
      width: 80%;
      border-radius: 10px;
      border: none;
      font-size: 16px;
    }
    #withdrawSection {
      margin-top: 20px;
    }
    table {
      width: 100%;
      margin-top: 15px;
      border-collapse: collapse;
    }
    td, th {
      padding: 8px;
      border: 1px solid red;
    }
  </style>
</head>
<body>

  <!-- رصيد العملات -->
  <div class="card">
    <h1>عملاتي</h1>
    <p id="coinCount">0</p>
  </div>

  <!-- جمع كوينات -->
  <div class="card">
    <h2>جمع كوينات الآن</h2>
    <button onclick="window.location.href='tasks.html'">ابدأ المهمة</button>
  </div>

  <!-- الانضمام للجروب -->
  <div class="card" id="groupSection">
    <button onclick="joinGroup()">ادخل الجروب من هنا</button>
    <br><br>
    <input type="text" id="robloxName" placeholder="اكتب اسمك في روبلوكس">
  </div>

  <!-- عداد 14 يوم -->
  <div class="card" id="countdownSection" style="display:none;">
    <h3 id="countdownText">جارٍ العد التنازلي...</h3>
    <div id="withdrawButton" style="display:none;">
      <button onclick="goToWithdraw()">تقدر تسحب الآن</button>
    </div>
  </div>

  <!-- الطلبات -->
  <div class="card" id="requestsSection">
    <h3>طلبات السحب</h3>
    <table id="requestsTable">
      <thead>
        <tr><th>الكمية</th><th>الحالة</th><th>التاريخ</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- دخول الديسكورد -->
  <div class="card">
    <button onclick="window.open('https://discord.gg/XXX')">دخول سيرفر الديسكورد</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAX8PWbKfWeBYzmX7sdrBhIT0Wp1yPjR04",
      authDomain: "hemaern.firebaseapp.com",
      databaseURL: "https://hemaern-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hemaern",
      storageBucket: "hemaern.appspot.com",
      messagingSenderId: "533729874483",
      appId: "1:533729874483:web:142462fdbd96156fe30946"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let currentUser;

    auth.onAuthStateChanged(user => {
      if (!user) return location.href = "login.html";
      currentUser = user;
      loadUserData();
      loadRequests();
    });

    function joinGroup() {
      const name = document.getElementById('robloxName').value.trim();
      if (!name) return alert('ادخل اسمك في روبلوكس');

      db.ref('users/' + currentUser.uid).update({
        robloxName: name,
        inGroup: true,
        groupJoinDate: new Date().toISOString()
      }).then(() => {
        document.getElementById('groupSection').style.display = 'none';
        startCountdown(new Date().toISOString());
      });
    }

    function loadUserData() {
      db.ref('users/' + currentUser.uid).once('value').then(snapshot => {
        const data = snapshot.val();
        document.getElementById('coinCount').innerText = data.coins?.collected || 0;

        if (data.inGroup && data.groupJoinDate) {
          document.getElementById('groupSection').style.display = 'none';
          startCountdown(data.groupJoinDate);
        }
      });
    }

    function startCountdown(joinDate) {
      document.getElementById('countdownSection').style.display = 'block';
      const target = new Date(joinDate);
      target.setDate(target.getDate() + 14);

      const timer = setInterval(() => {
        const now = new Date();
        const diff = target - now;
        if (diff <= 0) {
          document.getElementById('countdownText').innerText = 'المدة انتهت، يمكنك السحب الآن!';
          document.getElementById('withdrawButton').style.display = 'block';
          clearInterval(timer);
          return;
        }

        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const m = Math.floor((diff / (1000 * 60)) % 60);
        const s = Math.floor((diff / 1000) % 60);

        document.getElementById('countdownText').innerText = `العد التنازلي: ${d} يوم ${h} ساعة ${m} دقيقة ${s} ثانية`;
      }, 1000);
    }

    function goToWithdraw() {
      window.location.href = 'withdraw.html';
    }

    function loadRequests() {
      db.ref('withdrawRequests/' + currentUser.uid).on('value', snap => {
        const tableBody = document.querySelector("#requestsTable tbody");
        tableBody.innerHTML = '';
        snap.forEach(req => {
          const { amount, status, date } = req.val();
          const row = `<tr><td>${amount}</td><td>${status}</td><td>${new Date(date).toLocaleDateString()}</td></tr>`;
          tableBody.innerHTML += row;
        });
      });
    }
  </script>
</body>
</html>
